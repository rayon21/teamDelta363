<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Requests</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header>
        <a href="/security/requests">
            <img class="logo" src="/img/sfu-logo@2x.png" alt="sfu-logo"/>
        </a>
    </header>
    <div class="container col-md-10 offset-md-1 wrapper mb-5 col-lg-10" id="app">
        <div class="container col-md-10">
            <div class="row mt-5">
                <h1 class="mt-5">Requests</h1>
            </div>
            <div class="row pull-right">
                <div class="dropdown">
                    <div class="dropdown-toggle" id="dropdownMenuButton" data-toggle="dropdown"><i class="fa fa-cog"></i></div>
                    <ul class="dropdown-menu">
                        <li class="dropdown-item">Export to CSV</li>
                    </ul>
                </div>

            </div>
            <div class="row mt-5">
                <div class="input-group search-group">
                    <span class="fa fa-search"></span>
                    <input type="text" class="form-control" id="search-bar" v-model="searchTerm" placeholder="search"/>
                    <div class="error"></div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-8 mx-auto">
                    <ul class="nav nav-pills nav-fill">
                        <li class="nav-item"><a href="" v-on:click.stop.prevent="activeStatus='ALL'" v-bind:class="{'active': isActive('ALL')}" class="nav-link">All</a></li>
                        <li class="nav-item"><a href="" v-on:click.stop.prevent="activeStatus='WAITING'" v-bind:class="{'active': isActive('WAITING')}"class="nav-link">Waiting</a></li>
                        <li class="nav-item"><a href="" v-on:click.stop.prevent="activeStatus='APPROVED'" v-bind:class="{'active': isActive('APPROVED')}"class="nav-link">Approved</a></li>
                        <li class="nav-item"><a href="" v-on:click.stop.prevent="activeStatus='REJECTED'" v-bind:class="{'active': isActive('REJECTED')}"class="nav-link">Rejected</a></li>
                    </ul>
                </div>
            </div>
            <div class="row mt-4">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th v-for="column in columns" v-on:click="sortBy(column)" class="clickable" v-cloak>{{column}}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="request in filteredRequests" v-on:click="goToRequest(request.requestID)"v-cloak>
                                <!--<td v-for="value in request" class="clickable" v-on:click="goToRequest(request.requestID)">{{value}}</td>-->
                                <td class="clickable text-primary">{{request.requestID}}</td>
                                <td class="clickable">{{request.requesterName}}</td>
                                <td class="clickable">{{request.requesterID}}</td>
                                <td class="clickable">{{request.requestedOnDate}}</td>
                                <td class="clickable">{{request.emailAddress}}</td>
                                <td class="clickable">{{request.phoneNumber}}</td>
                                <td class="clickable">{{request.eventName}}</td>
                                <td class="clickable">{{request.eventLocation}}</td>
                                <td class="clickable">{{request.eventDates}}</td>
                                <td class="clickable">{{request.status}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <span class="text-muted mx-auto" v-if="showNoResults()">No results.</span>
                <div class="loader loader--style3 mx-auto" title="2" v-if="loading">
                    <svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     width="40px" height="40px" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50;" xml:space="preserve">
                    <path fill="#000" d="M43.935,25.145c0-10.318-8.364-18.683-18.683-18.683c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615c8.072,0,14.615,6.543,14.615,14.615H43.935z">
                        <animateTransform attributeType="xml"
                          attributeName="transform"
                          type="rotate"
                          from="0 25 25"
                          to="360 25 25"
                          dur="0.6s"
                          repeatCount="indefinite"/>
                    </path>
                  </svg>
                </div>
            </div>
        </div>
        <div class="bottom-space"></div>
    </div>
</body>
<script src="/js/jquery-3.2.1.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/vue.js"></script>
<script src="/js/vue-resource.min.js"></script>
<script>
    function getKeyByValue(object, value) {
        return Object.keys(object).find(key => object[key] === value);
    }
    function isTermInObject(object, term) {
        //debugger;
        for (var prop in object) {
            if (object.hasOwnProperty(prop) && (object[prop] != null)) {
                if (object[prop].toString().toLowerCase().includes(term.toLowerCase())) {
                    return true;
                }
            }

        }
        return false;
    }
    function readCookie(name) {
        // source: https://stackoverflow.com/a/1599291
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }
    var app = new Vue({
        el: '#app',
        data: {
            loading: true,
            columns: ["Request ID", "Name", "ID", "Request Date", "Email",
                        "Phone", "Event Name", "Location", "Date", "Status"],
            activeStatus: "ALL",
            searchTerm: "",
            sortKey: "",
            reversed: true,
            requests: [

            ]
        },
        methods: {
            isActive: function(status) {
                return this.activeStatus == status;
            },
            sortBy: function(sortKey) {
                this.reversed = !this.reversed;
                this.sortKey = sortKey;
            },
            getColumnValue(columnName) {
                let mappings = {
                    // value: columnName
                    requestID: "Request ID",
                    requesterName: "Name",
                    requesterID: "ID",
                    requestedOnDate: "Request Date",
                    emailAddress: "Email",
                    phoneNumber: "Phone",
                    eventName: "Event Name",
                    Location: "Location",
                    eventDates: "Date",
                    status: "Status"
                }
                return getKeyByValue(mappings, columnName);
            },
            goToRequest(requestID) {
                window.location.assign("/request/" + requestID);
            },
            showNoResults: function() {
                return this.filteredRequests.length == 0 && !this.loading;
            }
        },
        computed: {
            filteredRequests: {
                cache: false,
                get: function() {
                    return this.requests.filter(request => {
                        return isTermInObject(request, this.searchTerm);
                    }).sort((requestA, requestB) => {
                        return this.reversed ? requestA[this.getColumnValue(this.sortKey)] > requestB[this.getColumnValue(this.sortKey)] :
                            requestA[this.getColumnValue(this.sortKey)] < requestB[this.getColumnValue(this.sortKey)];
                    }).filter(request => {
                        if(this.activeStatus == "ALL") {
                            return true;
                        } else {
                            return request.status.toLowerCase() == this.activeStatus.toLowerCase();
                        }
                    });

                }
            }
        },
        created: function() {
            var token = readCookie('sfu-event-form-authtoken');

            this.$http.get('/api/form/search', {
                pageSize: 100,
                pageNumber: 1,
                authtoken: token
            }).then(response  => {
                this.requests = response.data;
                this.loading = false;
            });
        }

    });
</script>
</html>